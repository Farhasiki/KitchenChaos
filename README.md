# KitchenChaos 流程

[toc]

## 前言

* 当前 demo 主要倾向代码的书写，对性能方面有舍弃。
  * 从书写代码习惯上近一切可能的避免了字符串匹配，所以会有在 Update 函数中使用 GetComponent 的情况（单个 GameObject 的组件控制数量）。
* 场景物体很少所以采用的同步加载场景。

## 1. 模型设置

### 1.1 玩家模型

* 玩家模型很简单，是由两个球和一对大眼睛组成,主要是要设置玩家拿物品的放置点。

### 1.2 柜台模型

* 空柜台，存货柜台，切菜柜台，提交柜台，出盘柜台，烤肉柜台，垃圾桶。对于模型的设置主要有物品的放置点，柜台被选择时的外观，以及个别特殊柜台带的 3D 场景的 UI。
  * 对于被选择时的模型外观我们只让一个比原模型稍微大一圈的浅色材质，在被选择中的时候控制显隐即可。

### 1.3 食物（可持）模型

* 卷心菜、卷心菜叶、奶酪、奶酪片、番茄、番茄片、面包、肉饼、熟肉饼、烤焦肉饼、盘子。模型无额外设置，不过对于食物类的物品设有物品信息方便在**订单管理器**进行处理。

### 1.4 场景模型

* 墙、背景物块，地板。简单的几何体拼接，上色依靠个人审美。

## 2. 场景设置

### 2.1 主场景

* 由四个玩家模型处于静态时的动画构成。
* 进入游戏和退出游戏的UI

### 2.2 中间加载场景

* 切换场景用的是同步加载场景（场景的内容较少），中间加载场景负责短暂的停留，场景内没有任何物体，只有回调函数负责加载目标场景。

### 2.3 游戏场景

#### 2.3.1 场景设置

* 可由上述模型随意布置，当前场景布置为简单的方框状。

#### 2.3.2 UI 设置

* 对所有的 UI 没有设置预制体，直接保存在场景中，UI 的显隐直接由物体的显隐控制。

1. 开始前的指导 UI：图片提供玩家的基本操作信息，按交互键关闭并开始游戏。
2. 游戏进行时的倒计时 UI 以及游戏开始前倒计时 UI：通过 Animation 的设置实现倒计时数字的闪烁效果，通过 UI 的360°填充模式控制游戏倒计时的圆形 UI 的旋转式倒计时。
3. 提交的订单列表 UI：通过**订单管理器**提供的订单向用户展示订单任务。**订单管理器**负责更新界面。
4. 游戏暂停 UI：玩家按暂停键可打开界面，在界面中可选择回到游戏，设置，退出到主界面。也可以再按一次暂停键回到游戏。
5. 设置 UI：可以点击 音效，音乐按钮调节声音的大小，点击按键可重新绑定按键。音乐的大小可以持久保存。
6. 游戏结束 UI：游戏倒计时结束时出现结束界面，可观察玩家获得的分数，玩家停止操作。

## 3. 玩家控制

### 3.1 玩家移动

1. 结合新输入系统，将玩家移动的向量获取通过新系统的输入事件获取二维向量。
2. 没有采用物理系统的 Rigidbody 碰撞检测 采用射线检测进行碰撞模拟。
   * 保证胶囊型的玩家可以实现真实的碰撞效果，用胶囊状的射线检测是否有碰撞到物体。

#### 	遇到的问题

1. 在碰撞时如果斜向碰撞时会停止运动。
   * 需要对向量进行分解(x,z方向)，分别判断哪个方向可以前进。

2. 在旋转时用插值运算，如果出现180度的转身情况会倒退行走。
   * 在旋转角度上加一个微小的偏移向量 esp 保证玩家可以正常旋转。

3. 手柄玩家的遥杆是不能保证完全为0输入，会一直保持微小移动。
   * 在检测是否有移动输入时设置底线（小于 x 为零输入）（新输入系统也可以设置最大最小值）。

### 3.2 玩家交互

#### 3.2.1 与柜台交互

* 交互的多种情况
  * 柜台上未放置物品且玩家手里为空,
  * 柜台为空且玩家手里不为空，
  * 柜台上有物品且玩家手中没有物品，
  * 柜台上和玩家手上都有物品。

* **从上述情况中可以看出，玩家和柜台都是一个可以拿放物体的容器所以可以抽象，继承控制物品位置的接口即可。我们并不允许物品可以被玩家到处乱扔**

#### 3.2.2 在柜台上和物体交互

* 此交互过程发生在玩家切菜的时候，玩家将菜放到切菜柜台后可以交互，玩家将可切的食物放置到砧板上后可根据设定食物的切割次数进行多次操作将食物切片。

## 4. 玩家输入

* 两种输入系统都有保留。

### 4.1 新输入系统

* 主要是通过事件获取玩家的输入。通过图形界面选择绑定的按键以及返回值。同时也可以对不同输入设备或者组合进行绑定。

* 方便切换输入模式：驾驶模式的一套输入，玩家行走时的一套输入。可以通过新系统的 ActionMaps创建多套输入模式。不过在前demo 中只有一套输入模式。

* 新输入系统的事件在进入游戏场景才注册，而在切换场景的时候是不会被销毁的，所以要在 GameInput 销毁时在 OnDestroy 处将注册的事件清空。

* 按键重绑：我们需要将键位记下来，便于我们区分不同键位的绑定。当按键需要重绑前需要将输入系统关闭，检测输入。完成后执行回调并开启输入系统。

### 4.2 旧输入系统

* 主要是在前期测试的时候运用，测试玩家的移动，交互。不过在设置中保留了。	

## 5.柜台设置

* **对于物品在柜台和玩家之间的相互移动我们由玩家和柜台实现的物品转移的接口在承载点之间的转移。**

### 5.1 空柜台

* **要处理与玩家交互的所有四种情况。下述情况都以空柜台的情况为基准。**
  1. **如果柜台和玩家都未装载物品**：无效交互。
  2. **如果柜台上有物品且玩家手中为空**：玩家从柜台上拿起物品。
  3. **如果柜台上为空且玩家手中有物品**：玩家将物品放置到柜台上。
  4. **如果柜台上和玩家手中都有物品**：玩家手中有盘子时可将可放置到盘子中的食物转移到盘子上。是否可放置由盘子物体判断。

### 5.2 存货柜台

* 存货柜台上不能放置物品只需要处理第二种情况。

* 存货柜台可以储存多种食物，存放的食物由存货柜台的关键信息**食物信息数据结构**控制。

  #### 动画

  * 在玩家从柜台中取出食物时触发动画即可，简单的翻盖动画。

### 5.3 切菜柜台

* 放置交互需要处理 2、3、4 三种情况。

  * 第 2 种情况： 与空柜台相同。

  * 第 3 种情况：玩家将可以切片的食物放到切菜柜台台上。对于可切片的食物判断,我们在切菜柜台上存储食物切片的食谱。如果放置的食物在食谱中输入食谱中则可放置。

  * 第 4 种情况：与空柜台相同。

* 切菜交互只需要处理第 2 种情况

  * 当食物还未被切时,我们根据柜台上的食物获取切菜的菜谱，当切割次数达到切割食谱设置的最大值时生成菜谱输出食物。

  #### 动画

  * 玩家按 F 交互键切菜时触发动画，切菜动画。
  * 展示切菜 3DUI 进度条由当前切菜次数和书谱总次数确定。
  * 切菜声音由**声音管理器**播放。

### 5.4 烤肉柜台

* 烤肉柜台本身有四种状态：空闲状态、烹饪状态、(肉)烤熟状态、(肉)烧焦状态。

  * 空闲状态：如果柜台上没有肉放置时柜台处于空闲状态。
  * 烹饪状态：当生肉被放置时进入烹饪状态，烹饪计时器开始计时。获取到烹饪食谱的烹饪时间和输出食物，当打到烹饪时间时进入下一状态，生成输出食物。
  * 烤熟状态：和上一状态的逻辑相同，差别为根据不同的食谱输出不同的食物，结束后进入烤熟状态。
  * 烤熟状态：不做逻辑处理。

* 与玩家交互时只处理第 3 种情况：玩家放入生肉进行肉饼的烹制，柜台进图烹饪状态。

  #### 动画

  * 当柜台上处于烹饪状态或者烤熟状态时，播放炉子火光以及粒子效果。
  * 根据当前烹饪进度，控制烹饪的 3DUI 进度条。
  * 当肉饼即将烧焦时播放警报动画。
  * 油炸声音和警报声音由**声音管理器控制**播放

### 5.5 出盘柜台

* 只需处理柜台交互的第 2、3个情况，玩家只可以从柜台上取出盘子，放回空盘子。

* 每隔一段时间，并且盘子的数量没有达到上限，柜台生成盘子在柜台上。 

  #### 动画

  * 控制每段时间生成盘子实体的位置以及销毁盘子。

### 5.6 提交柜台

* 与玩家交互时处理第 3 种情况：玩家手中有盘子时可提交订单，提交结果由订单系统返回结果。

  #### 动画

  * 玩家提交订单时，播放是否成功完成订单动画，成功与否由**订单管理器**给出,分别播放对应的图案。
  * 成功和失败的声音也由**声音管理器**播放

### 5.7 垃圾桶

* 与玩家交互式处理第三种情况：直接销毁玩家手中的物品。

## 6. 游戏管理

* 游戏有四个阶段：等待开始阶段、倒计时阶段、进行游戏阶段、游戏结束阶段。

### 6.1 等待开始阶段

* 等待玩家按下交互按键开始游戏，游戏进入游戏开始前倒计时阶段。

### 6.2 倒计时阶段

* 只负责控制倒计时 UI 面板，玩家可以移动，但不能交互。

### 6.3 进行游戏阶段

* 玩家可以移动并且交互，玩家尽可能发挥自己的时间规划能里在有限的时间内，完成尽可能多的订单，获取更高的分数！

### 6.4 游戏结束阶段

* 游戏结束，玩家不能进行交互，游戏结束 UI 面板观察自己的最终分数。可通过 ESC 推出游戏，再次进行游戏游玩。

## 7. 订单管理

* 玩家任务的分发者。给玩家提供随机的任务，玩家提交订单时判断玩家的订单是否有效，并给予玩家相应的积分。
* 订单系统通过计时器定时定时分发任务，最多可分发 MAX 个任务，当玩家提交订单时，遍历订单列表，如果有当前订单则成功提交，为玩家增加积分。并根据不同的结果播放相应的 UI 和声音。
* 订单的匹配，同只需根据每个订单内由食材编号计算的 hash 值匹配即可。

## 8. 声音管理

* 游戏的声音和音效都可以持久化的存储，因为只有当前一种数据需要被存储，我们采用 Unity 带的存储方式 PlayerPrefs 对数据存储

### 8.1 音效管理

*  游戏内有着非常丰富的音效，玩家的移动、物品的转移（玩家拿起物品，玩家放置物品，物品的生成）、切菜，将物品放进垃圾桶、提交订单（订单成功，订单失败）。
* 烤肉柜台的音效并不是由**音效管理器**控制的，因为烤肉柜台有四种状态，在状态切换时会才会触发音效，所以由柜台单独控制。

### 8.2 音乐管理

* 游戏的音乐只有在游戏进入游戏场景时才会播放，只在场景中循环播放。

## 9. 重置静态数据

* 在玩家和垃圾桶和切菜柜台交互以及物品生成时需要播放音效，将会发出声音的柜台声明静态事件，**声音管理器**只需要知道发出声音的柜台位置即可。需要在切换场景时将时间清空，避免时间多次注册。

## 10. 3D场景中的 UI 控制

* 场景中设有多个 3D UI 我们需要控制他们的朝向，达到美观的效果。
* 对此我们可以编写脚本设置 UI 的朝向模式。共四种：面向摄像机、背向摄像机、面向摄像机的朝向、背向摄像机的朝向。
* 其实不仅可以控制 UI 的朝向也可以控制物体的朝向，只不过场景内除了玩家，其他物体的位置都是不变的，所以朝向问题在搭建场景时就固定了。

## 11 游戏流程

* 进入游戏，可观察到可爱的模型等待时的动画，点击 PLAY 按钮进行游玩，玩家可以按随时按 ESC 到暂停界面调整游戏内声音大小或者重绑按键选择自己舒适的案件搭配。在指导阶段玩家可以观察操作方式 按下交互按键等待游戏开始，热身计时结束，游戏开始！玩家需要根据系统分发的订单在有限的时间内制作出顾客需要的食物并提交。游戏计时结束，玩家可观察自己获得的分数。点击 QUIT 退出到主场景再 QUIT 则退出游戏。
